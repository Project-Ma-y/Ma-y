<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Firebase Login Test (mayservice)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; max-width: 560px; margin: 40px auto; padding: 0 16px; }
    h1 { font-size: 1.25rem; }
    form, .row { display: grid; gap: 8px; margin: 16px 0; }
    input { padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 8px; }
    button { padding: 10px 14px; border: 0; border-radius: 8px; font-size: 15px; cursor: pointer; }
    button.primary { background: #0ea5e9; color: white; }
    button.secondary { background: #e5e7eb; }
    .muted { color: #666; font-size: 12px; }
    pre { background: #0b1020; color: #e5e7eb; padding: 12px; border-radius: 8px; overflow: auto; max-height: 320px; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .row-inline { display: flex; gap: 8px; align-items: center; }
    .pill { font-size: 12px; background: #eef2ff; color: #3730a3; padding: 2px 8px; border-radius: 999px; }
  </style>
</head>
<body>
  <h1>Firebase 로그인 테스트</h1>

  <div class="muted">
    아이디 입력 시 <strong>@may.com</strong>이 자동으로 붙습니다. 이미 @가 있으면 그대로 사용합니다.
  </div>

  <form id="loginForm">
    <label>
      아이디
      <input id="idInput" type="text" placeholder="ex) user123" autocomplete="username email" required />
    </label>
    <label>
      비밀번호
      <input id="pwInput" type="password" placeholder="비밀번호" autocomplete="current-password" required />
    </label>
    <button class="primary" type="submit">로그인</button>
  </form>

  <div class="row-inline">
    <button id="btnToken" class="secondary" type="button">ID 토큰 보기</button>
    <button id="btnLogout" class="secondary" type="button">로그아웃</button>
    <button id="btnStored" class="secondary" type="button">저장된 토큰 보기</button>
    <button id="btnClear" class="secondary" type="button">저장된 토큰 삭제</button>
    <span id="authState" class="pill">로그아웃 상태</span>
  </div>

  <div class="muted">정규화된 이메일: <code id="normalizedEmail">-</code></div>

  <h3>로그</h3>
  <pre id="log"><code>// 여기 로그가 출력됩니다.</code></pre>

  <!-- Firebase Web SDK (ESM) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // ---- Firebase 설정 ----
    const firebaseConfig = {
      apiKey: "AIzaSyAaHhbv_xlkIwgp8BDI4ekkmRBl9bLI_pw",
      authDomain: "projectmay-358b7.firebaseapp.com",
      projectId: "projectmay-358b7",
      storageBucket: "projectmay-358b7.firebasestorage.app",
      messagingSenderId: "527237934658",
      appId: "1:527237934658:web:a6351a12ea9f9de13007db",
      measurementId: "G-VQWRV48PQF"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // ---- 유틸 ----
    const $ = (sel) => document.querySelector(sel);
    const logEl = $("#log");
    const emailOut = $("#normalizedEmail");
    const stateEl = $("#authState");

    function normalizeEmail(id) {
      const trimmed = (id || "").trim();
      if (!trimmed) return "";
      if (trimmed.includes("@")) return trimmed;
      return `${trimmed}@may.com`;
    }

    function log(obj, title = "") {
      const time = new Date().toLocaleTimeString();
      const prefix = title ? `[${time}] ${title}\n` : `[${time}] `;
      logEl.textContent = prefix + (typeof obj === "string" ? obj : JSON.stringify(obj, null, 2)) + "\n\n" + logEl.textContent;
    }

    // ---- Auth 상태 표시 ----
    onAuthStateChanged(auth, (user) => {
      if (user) {
        stateEl.textContent = "로그인 상태";
        stateEl.style.background = "#dcfce7";
        stateEl.style.color = "#166534";
        log({ uid: user.uid, email: user.email }, "onAuthStateChanged: signed-in");
      } else {
        stateEl.textContent = "로그아웃 상태";
        stateEl.style.background = "#fee2e2";
        stateEl.style.color = "#991b1b";
        log("signed-out", "onAuthStateChanged");
      }
    });

    // ---- 폼 동작 ----
    const form = document.getElementById("loginForm");
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const id = document.getElementById("idInput").value;
      const password = document.getElementById("pwInput").value;

      const email = normalizeEmail(id);
      emailOut.textContent = email || "-";

      if (!email || !password) {
        log("아이디/비밀번호를 입력하세요.", "검증");
        return;
      }

      try {
        const cred = await signInWithEmailAndPassword(auth, email, password);
        log({ uid: cred.user.uid, email: cred.user.email }, "로그인 성공");

        // 로그인 성공 → 토큰 발급 + 로컬스토리지 저장
        const token = await cred.user.getIdToken(/* forceRefresh */ true);
        localStorage.setItem("idToken", token);
        log("idToken이 localStorage에 저장되었습니다.", "저장");

      } catch (err) {
        log(err instanceof Error ? { name: err.name, message: err.message } : err, "로그인 실패");
      }
    });

    // ---- 현재 ID 토큰 보기 ----
    document.getElementById("btnToken").addEventListener("click", async () => {
      const u = auth.currentUser;
      if (!u) return log("현재 로그인된 사용자가 없습니다.", "ID 토큰");
      try {
        const token = await u.getIdToken(/* forceRefresh */ true);
        log({ token: token.slice(0, 40) + "...", length: token.length }, "ID 토큰(실시간)");
      } catch (err) {
        log(err instanceof Error ? { name: err.name, message: err.message } : err, "ID 토큰 오류");
      }
    });

    // ---- 로그아웃 ----
    document.getElementById("btnLogout").addEventListener("click", async () => {
      try {
        await signOut(auth);
        log("로그아웃 완료", "로그아웃");
      } catch (err) {
        log(err instanceof Error ? { name: err.name, message: err.message } : err, "로그아웃 오류");
      }
    });

    // ---- 저장된 토큰 보기 ----
    document.getElementById("btnStored").addEventListener("click", () => {
      const stored = localStorage.getItem("idToken");
      if (stored) {
        log({ token: stored.slice(0, 40) + "...", length: stored.length }, "저장된 토큰");
      } else {
        log("저장된 토큰이 없습니다.", "저장된 토큰");
      }
    });

    // ---- 저장된 토큰 삭제 ----
    document.getElementById("btnClear").addEventListener("click", () => {
      localStorage.removeItem("idToken");
      log("저장된 idToken을 삭제했습니다.", "삭제");
    });

    // ---- 아이디 입력 시 이메일 미리보기 업데이트 ----
    document.getElementById("idInput").addEventListener("input", (e) => {
      emailOut.textContent = normalizeEmail(e.target.value) || "-";
    });
  </script>
</body>
</html>
