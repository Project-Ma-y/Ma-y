<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Admin API 테스트</title>
</head>
<body>
  <h1>Admin API 테스트</h1>
  <p>로컬스토리지에 idToken이 있어야 합니다.</p>

  <div>
    <h2>가입자 집계 조회</h2>
    <button id="getAllUsers">전체 회원 조회</button>
  </div>

  <div>
    <h2>회원 상세 조회</h2>
    <input type="text" id="userIdInput" placeholder="유저 ID 입력" />
    <button id="getUserById">조회</button>
  </div>

  <div>
    <h2>회원 삭제</h2>
    <input type="text" id="deleteUserIdInput" placeholder="삭제할 유저 ID 입력" />
    <button id="deleteUser">삭제</button>
  </div>

  <div>
    <h2>통계</h2>
    <button id="signupConversion">회원가입 전환율</button>
    <button id="applicationReach">동행신청 페이지 도달율</button>
    <button id="applicationConversion">동행신청 전환율</button>
  </div>

  <h3>응답 결과</h3>
  <pre id="output"></pre>

  <script>
    const output = document.getElementById("output");
    const API_BASE = "https://ma-y-5usy.onrender.com/api";

    // 로컬스토리지에서 idToken 꺼내기
    const idToken = localStorage.getItem("idToken");
    if (!idToken) {
      output.textContent = "⚠️ idToken이 없습니다. 먼저 로그인하세요.";
    }

    // 공통 fetch 함수
    async function apiRequest(endpoint, method = "GET") {
      try {
        const res = await fetch(`${API_BASE}${endpoint}`, {
          method,
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${idToken}`
          },
          credentials: "include"
        });

        const data = await res.json();
        output.textContent = JSON.stringify(data, null, 2);
      } catch (error) {
        output.textContent = `❌ 요청 실패: ${error.message}`;
      }
    }

    // 이벤트 리스너 설정
    document.getElementById("getAllUsers").addEventListener("click", () => {
      apiRequest("/users");
    });

    document.getElementById("getUserById").addEventListener("click", () => {
      const userId = document.getElementById("userIdInput").value.trim();
      if (!userId) return alert("유저 ID를 입력하세요");
      apiRequest(`/users/${userId}`);
    });

    document.getElementById("deleteUser").addEventListener("click", () => {
      const userId = document.getElementById("deleteUserIdInput").value.trim();
      if (!userId) return alert("삭제할 유저 ID를 입력하세요");
      apiRequest(`/users/${userId}`, "DELETE");
    });

    document.getElementById("signupConversion").addEventListener("click", () => {
      apiRequest("/stats/signup-conversion");
    });

    document.getElementById("applicationReach").addEventListener("click", () => {
      apiRequest("/stats/application-reach");
    });

    document.getElementById("applicationConversion").addEventListener("click", () => {
      apiRequest("/stats/application-conversion");
    });
  </script>
</body>
</html>
