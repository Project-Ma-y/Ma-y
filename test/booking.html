<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>예약 테스트</title>
</head>
<body>
  <h2>Firebase 로그인</h2>
  <form id="loginForm">
    <label>이메일: <input type="email" id="email" required /></label><br><br>
    <label>비밀번호: <input type="password" id="password" required /></label><br><br>
    <button type="submit">로그인</button>
  </form>

  <h2>예약 생성</h2>
  <form id="bookingForm">
    <label>날짜: <input type="date" id="date" required /></label><br><br>
    <label>장소: <input type="text" id="place" required /></label><br><br>
    <label>가격(원): <input type="number" id="price" required /></label><br><br>
    <button type="submit">예약하기</button>
  </form>

  <h3>응답 결과</h3>
  <pre id="output"></pre>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
          apiKey: "AIzaSyALislKfX7MQeh1IteqWiiaxYGJ_KrNZN4",
            authDomain: "ma-y-b1fa6.firebaseapp.com",
            databaseURL: "https://ma-y-b1fa6-default-rtdb.firebaseio.com",
            projectId: "ma-y-b1fa6",
            storageBucket: "ma-y-b1fa6.firebasestorage.app",
            messagingSenderId: "48645617538",
            appId: "1:48645617538:web:23d556cdd2c5b223b2019b",
            measurementId: "G-8CPE7B7PLN",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    let idToken = ""; // 로그인 후 저장

    const loginForm = document.getElementById("loginForm");
    const bookingForm = document.getElementById("bookingForm");
    const output = document.getElementById("output");

    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;

      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        idToken = await userCredential.user.getIdToken();
        output.textContent = "✅ 로그인 성공. 토큰 확보 완료";
      } catch (error) {
        output.textContent = `❌ 로그인 실패: ${error.message}`;
      }
    });

    bookingForm.addEventListener("submit", async (e) => {
      e.preventDefault();

          const idToken = localStorage.getItem("idToken"); // ✅ 저장된 토큰 가져오기
          
      if (!idToken) {
        output.textContent = "❌ 먼저 로그인하세요";
        return;
      }

      const body = {
        date: document.getElementById("date").value,
        place: document.getElementById("place").value,
        price: parseInt(document.getElementById("price").value),
      };

      try {
        const res = await fetch("https://ma-y-5usy.onrender.com/api/booking", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${idToken}`,
          },
          credentials: "include", // 세션 쿠키 포함
          body: JSON.stringify(body),
        });

        const data = await res.json();
        output.textContent = JSON.stringify(data, null, 2);
      } catch (err) {
        output.textContent = `❌ 예약 실패: ${err.message}`;
      }
    });
  </script>
</body>
</html>
